name: visa-cron

on:
  schedule:
    - cron: "0 7-19/2 * * *"  # cada 2 horas entre 07:00–19:00
  workflow_dispatch:

concurrency:
  group: visa-cron
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  validate-secrets:
    name: validate-secrets (manual only)
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Compute hashes and validate formats
        env:
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
          SCHEDULE_ID: ${{ secrets.SCHEDULE_ID }}
          PRIOD_START: ${{ secrets.PRIOD_START }}
          PRIOD_END: ${{ secrets.PRIOD_END }}
          YOUR_EMBASSY: ${{ secrets.YOUR_EMBASSY }}
          PUSHOVER_TOKEN: ${{ secrets.PUSHOVER_TOKEN }}
          PUSHOVER_USER: ${{ secrets.PUSHOVER_USER }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
        run: |
          set -euo pipefail
          echo "Validando secretos (se muestran SHA-256 y longitud, nunca el valor):"
          for key in USERNAME PASSWORD SCHEDULE_ID PRIOD_START PRIOD_END YOUR_EMBASSY PUSHOVER_TOKEN PUSHOVER_USER SENDGRID_API_KEY; do
            val="${!key:-}"
            if [ -z "$val" ]; then
              echo "- $key: MISSING"
            else
              len=${#val}
              hash=$(printf "%s" "$val" | sha256sum | awk '{print $1}')
              echo "- $key: len=$len sha256=$hash"
            fi
          done

          echo "\nValidaciones de formato básicas:"
          fail=0
          # USERNAME como email básico
          if [ -n "${USERNAME:-}" ] && echo "$USERNAME" | grep -Eq '^[^@]+@[^@]+\.[^@]+$'; then
            echo "✓ USERNAME parece email"
          else
            echo "✗ USERNAME no parece email"; fail=1
          fi
          # SCHEDULE_ID solo dígitos
          if [ -n "${SCHEDULE_ID:-}" ] && echo "$SCHEDULE_ID" | grep -Eq '^[0-9]+$'; then
            echo "✓ SCHEDULE_ID numérico"
          else
            echo "✗ SCHEDULE_ID no es numérico"; fail=1
          fi
          # Fechas YYYY-MM-DD
          if [ -n "${PRIOD_START:-}" ] && echo "$PRIOD_START" | grep -Eq '^\d{4}-\d{2}-\d{2}$'; then
            echo "✓ PRIOD_START con formato YYYY-MM-DD"
          else
            echo "✗ PRIOD_START formato inválido (esperado YYYY-MM-DD)"; fail=1
          fi
          if [ -n "${PRIOD_END:-}" ] && echo "$PRIOD_END" | grep -Eq '^\d{4}-\d{2}-\d{2}$'; then
            echo "✓ PRIOD_END con formato YYYY-MM-DD"
          else
            echo "✗ PRIOD_END formato inválido (esperado YYYY-MM-DD)"; fail=1
          fi
          # Validación de presencia de tokens notificación
          if [ -z "${PUSHOVER_TOKEN:-}" ] || [ -z "${PUSHOVER_USER:-}" ]; then
            echo "⚠ Pushover incompleto (opcional si no usas Pushover)"
          else
            echo "✓ Pushover configurado"
          fi

          # Validar YOUR_EMBASSY contra lista del repo
          python - << 'PY'
import sys
import os
emb = os.environ.get('YOUR_EMBASSY','').strip()
try:
    import embassy as E
except Exception as e:
    print('✗ No se pudo importar embassy.py:', e)
    sys.exit(1)
if emb in E.EMBASSY:
    print('✓ YOUR_EMBASSY existe en embassy.py:', emb)
else:
    print('✗ YOUR_EMBASSY no coincide. Valor:', emb)
    print('  Claves válidas:', ', '.join(sorted(E.EMBASSY.keys())))
    sys.exit(1)
PY

          if [ "$fail" -ne 0 ]; then
            echo "\nAlgunas validaciones fallaron"; exit 1
          fi

  run:
    if: ${{ github.event_name != 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    services:
      selenium:
        image: selenium/standalone-chrome:latest
        options: >-
          --shm-size=2g
        ports:
          - 4444:4444
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate config.ini
        run: |
          # Primera pasada: Alerta únicamente para citas entre ALERT_START y ALERT_END (DRY_RUN=True)
          cat > config.ini <<EOF
          [PERSONAL_INFO]
          USERNAME = ${{ secrets.USERNAME }}
          PASSWORD = ${{ secrets.PASSWORD }}
          SCHEDULE_ID = ${{ secrets.SCHEDULE_ID }}
          PRIOD_START = ${{ vars.PRIOD_START }}
          PRIOD_END = ${{ vars.PRIOD_END }}
          YOUR_EMBASSY = ${{ vars.YOUR_EMBASSY }}
          ASSIGN_CUTOFF = ${{ vars.ASSIGN_CUTOFF }}

          [CHROMEDRIVER]
          LOCAL_USE = False
          HUB_ADDRESS = http://localhost:4444/wd/hub

          [NOTIFICATION]
          PUSHOVER_TOKEN = ${{ secrets.PUSHOVER_TOKEN }}
          PUSHOVER_USER = ${{ secrets.PUSHOVER_USER }}
          SENDGRID_API_KEY = ${{ secrets.SENDGRID_API_KEY }}
          PERSONAL_SITE_USER =
          PERSONAL_SITE_PASS =
          PUSH_TARGET_EMAIL =
          PERSONAL_PUSHER_URL =

          [TIME]
          RETRY_TIME_L_BOUND = 10
          RETRY_TIME_U_BOUND = 120
          WORK_LIMIT_TIME = 1.5
          WORK_COOLDOWN_TIME = 2.25
          BAN_COOLDOWN_TIME = 5

          [RUN]
           HEADLESS = True
           DRY_RUN = False
           ONE_SHOT = True
          EOF
          
          sleep $((RANDOM % 120))
          python visa.py

      - name: Echo config variables in logs (non-sensitive)
        run: |
          echo "Using YOUR_EMBASSY=${{ vars.YOUR_EMBASSY }}"
          echo "Using PRIOD_START=${{ vars.PRIOD_START }}"
          echo "Using PRIOD_END=${{ vars.PRIOD_END }}"

      - name: Print selenium logs on failure
        if: failure()
        run: |
          echo "Selenium container logs:" && docker logs ${{ job.services.selenium.id }} | tail -n 200 || true
      - name: Upload debug artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: visa-debug
          path: |
            page_debug.html
            screenshot.png
            log_*.txt

      - name: Wait for Selenium Grid
        run: |
          echo "Waiting for Selenium Grid..."
          for i in {1..30}; do
            if curl -sSf http://localhost:4444/wd/hub/status | jq -r '.value.ready' | grep -q true; then
              echo "Grid ready"; break
            else
              sleep 2
            fi
          done
        shell: bash
